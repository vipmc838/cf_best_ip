name: 更新代理列表

on:
  schedule:
    - cron: '0 23 * * *'  # 北京时间早上7点
    - cron: '0 11 * * *'  # 北京时间晚上7点
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main
      
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        
    - name: 抓取代理列表
      run: |
        echo "开始抓取代理列表..."
        python s5/generate_proxy_list.py
        echo "抓取完成，检查文件..."
        if [ -f s5/proxy.txt ]; then
          echo "s5/proxy.txt 文件已生成"
          echo "文件内容预览："
          head -10 s5/proxy.txt
        else
          echo "s5/proxy.txt 文件未生成"
          exit 1
        fi
        
    - name: 提交更新
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git add s5/proxy.txt
        if git diff --staged --quiet; then
          echo "没有更改需要提交"
        else
          git commit -m "更新代理列表 $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi

    - name: 清理工作流记录
      if: always()
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        delete_workflow_pattern: ${{ github.workflow }}
        retain_days: 0
        keep_minimum_runs: 3
