name: CloudFlareä¼˜é€‰IP + åä¸ºäº‘æ›´æ–°DNS

on:
  schedule:
    - cron: '0 */1 * * *' # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥IPå˜åŒ–æ£€æµ‹ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
      FORCE_UPDATE: ${{ inputs.force_update }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”’ éšè—æ•æ„Ÿä¿¡æ¯
        run: |
          echo "::add-mask::${{ secrets.FULL_DOMAIN }}"
          echo "::add-mask::${{ secrets.HUAWEI_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.HUAWEI_SECRET_KEY }}"
          echo "::add-mask::${{ secrets.TG_BOT_TOKEN }}"
          echo "::add-mask::${{ secrets.TG_USER_ID }}"
          echo "âœ… æ•æ„Ÿä¿¡æ¯å·²éšè—"

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ– (Chromium)
        run: |
          echo "ğŸ”§ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update -qq
          
          echo "ğŸ“¦ å®‰è£… Chromium åŠä¾èµ–..."
          sudo apt-get install -y --no-install-recommends \
            chromium-browser \
            chromium-chromedriver \
            fonts-liberation \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            xdg-utils > /dev/null 2>&1
          
          echo "âœ… Chromium ç‰ˆæœ¬: $(chromium-browser --version)"

      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ å‡çº§ pip..."
          python -m pip install --upgrade pip setuptools wheel -q
          
          echo "ğŸ“¦ å®‰è£…ä¾èµ–åŒ…..."
          pip install --no-cache-dir -q \
            requests>=2.31.0 \
            beautifulsoup4>=4.12.0 \
            requests-html>=0.10.0 \
            lxml>=4.9.0 \
            'lxml[html_clean]' \
            huaweicloudsdkcore>=3.1.0 \
            huaweicloudsdkdns>=3.1.0
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ”§ é…ç½® Chromium ç¯å¢ƒ
        run: |
          echo "PYPPETEER_CHROMIUM_REVISION=latest" >> $GITHUB_ENV
          echo "CHROMIUM_PATH=/usr/bin/chromium-browser" >> $GITHUB_ENV

      - name: âœ… æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
        id: check_env
        run: |
          ERROR=0
          
          if [ -z "$FULL_DOMAIN" ]; then
            echo "âŒ FULL_DOMAIN æœªè®¾ç½®"
            ERROR=1
          else
            echo "âœ… FULL_DOMAIN: å·²è®¾ç½®"
          fi
          
          if [ -z "$HUAWEI_ACCESS_KEY" ]; then
            echo "âŒ HUAWEI_ACCESS_KEY æœªè®¾ç½®"
            ERROR=1
          else
            echo "âœ… HUAWEI_ACCESS_KEY: å·²è®¾ç½®"
          fi
          
          if [ -z "$HUAWEI_SECRET_KEY" ]; then
            echo "âŒ HUAWEI_SECRET_KEY æœªè®¾ç½®"
            ERROR=1
          else
            echo "âœ… HUAWEI_SECRET_KEY: å·²è®¾ç½®"
          fi
          
          if [ -z "$HUAWEI_REGION" ]; then
            echo "âš ï¸  HUAWEI_REGION æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼"
          else
            echo "âœ… HUAWEI_REGION: ${HUAWEI_REGION}"
          fi
          
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_USER_ID" ]; then
            echo "âš ï¸  Telegram é€šçŸ¥æœªé…ç½®"
          else
            echo "âœ… Telegram é€šçŸ¥å·²é…ç½®"
          fi
          
          if [ $ERROR -eq 1 ]; then
            echo "âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"

      - name: ğŸš€ è¿è¡Œ DNS æ›´æ–°è„šæœ¬
        id: update_dns
        env:
          HIDE_DOMAIN: "true"  # éšè—åŸŸåè¾“å‡º
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ DNS æ›´æ–°..."
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
          if python cloudflare_dns_updater.py 2>&1 | grep -v "$FULL_DOMAIN" || true; then
            if [ ${PIPESTATUS[0]} -eq 0 ]; then
              echo "update_status=success" >> $GITHUB_OUTPUT
              echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            else
              echo "update_status=failed" >> $GITHUB_OUTPUT
              echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
              exit 1
            fi
          fi
          
          echo ""
          echo "ğŸ• ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "# ğŸ¯ Cloudflare DNS æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: \`å·²é…ç½®\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒºåŸŸ**: \`${HUAWEI_REGION:-ap-southeast-1}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ steps.update_dns.outputs.update_status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œç¼–å·**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            echo "## ğŸ“„ æ›´æ–°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ç»Ÿè®¡ IP æ•°é‡ï¼ˆä¸æ˜¾ç¤ºå…·ä½“åŸŸåï¼‰
            DEFAULT_V4=$(jq -r '.æœ€ä¼˜IP.é»˜è®¤ // [] | length' cloudflare_bestip.json 2>/dev/null || echo "0")
            DIANXIN_V4=$(jq -r '.æœ€ä¼˜IP.ç”µä¿¡ // [] | length' cloudflare_bestip.json 2>/dev/null || echo "0")
            LIANTONG_V4=$(jq -r '.æœ€ä¼˜IP.è”é€š // [] | length' cloudflare_bestip.json 2>/dev/null || echo "0")
            YIDONG_V4=$(jq -r '.æœ€ä¼˜IP.ç§»åŠ¨ // [] | length' cloudflare_bestip.json 2>/dev/null || echo "0")
            IPV6=$(jq -r '.æœ€ä¼˜IP.IPv6 // [] | length' cloudflare_bestip.json 2>/dev/null || echo "0")
            
            echo "| çº¿è·¯ | IPv4 æ•°é‡ | IPv6 æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| é»˜è®¤ | ${DEFAULT_V4} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| ç”µä¿¡ | ${DIANXIN_V4} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| è”é€š | ${LIANTONG_V4} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| ç§»åŠ¨ | ${YIDONG_V4} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| IPv6 | - | ${IPV6} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "> ğŸ’¡ è¯¦ç»† IP åˆ—è¡¨è¯·ä¸‹è½½ Artifacts æŸ¥çœ‹" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¦ ä¸Šä¼ ç»“æœæ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-bestip-${{ github.run_number }}
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7
          if-no-files-found: warn

      - name: ğŸ’¾ æäº¤ç»“æœåˆ°ä»“åº“
        if: success()
        id: commit
        run: |
          echo "ğŸ”§ é…ç½® Git..."
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
          git add cloudflare_bestip.json cloudflare_bestip.txt
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“Š æ–‡ä»¶å·²å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
            
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            # ä¸åœ¨æäº¤æ¶ˆæ¯ä¸­åŒ…å«åŸŸå
            COMMIT_MSG="ğŸ¤– Update Cloudflare Best IP - ${TIMESTAMP} [skip ci]"
            
            git commit -m "$COMMIT_MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æäº¤å®Œæˆ"
          fi

      - name: ğŸ”„ æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶æ¨é€
        if: success() && steps.commit.outputs.has_changes == 'true'
        run: |
          echo "ğŸ”„ æ‹‰å–è¿œç¨‹æ›´æ–°..."
          git pull --rebase origin ${{ github.ref_name }} || {
            echo "âš ï¸  æ‹‰å–å¤±è´¥ï¼Œå°è¯•è§£å†³å†²çª..."
            git rebase --abort || true
            git pull --no-rebase origin ${{ github.ref_name }}
          }
          
          echo "â¬†ï¸  æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          MAX_RETRIES=3
          RETRY=0
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… æ¨é€æˆåŠŸ"
              exit 0
            else
              RETRY=$((RETRY+1))
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œé‡è¯• $RETRY/$MAX_RETRIES..."
              sleep 5
              git pull --rebase origin ${{ github.ref_name }} || true
            fi
          done
          
          echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
          exit 1

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç† Chromium ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/.com.google.Chrome.* || true
          rm -rf /tmp/pyppeteer-* || true
          rm -rf ~/.pyppeteer || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“± å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_USER_ID" ]; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            MESSAGE="ğŸš¨ <b>DNS æ›´æ–°å¤±è´¥</b>%0A%0A"
            MESSAGE="${MESSAGE}ğŸ• æ—¶é—´: ${TIMESTAMP}%0A"
            MESSAGE="${MESSAGE}ğŸ”— æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0A"
            MESSAGE="${MESSAGE}è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ï¼"
            
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TG_USER_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML" \
              -d "disable_web_page_preview=true" > /dev/null 2>&1 || echo "âš ï¸  Telegram é€šçŸ¥å‘é€å¤±è´¥"
          fi
