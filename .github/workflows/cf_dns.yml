name: CloudFlareä¼˜é€‰IP + åŽä¸ºäº‘æ›´æ–°DNS

on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”’ éšè—æ•æ„Ÿä¿¡æ¯
        run: |
          echo "::add-mask::${{ secrets.FULL_DOMAIN }}"
          echo "::add-mask::${{ secrets.HUAWEI_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.HUAWEI_SECRET_KEY }}"
          echo "::add-mask::${{ secrets.TG_BOT_TOKEN }}"
          echo "::add-mask::${{ secrets.TG_USER_ID }}"

      - name: ðŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: |
          echo "ðŸ“¦ å®‰è£… Python åŒ…..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "ðŸ“¦ å®‰è£… Playwright æµè§ˆå™¨..."
          playwright install chromium --with-deps
          
          echo "âœ… å®‰è£…å®Œæˆ"

      - name: âœ… æ£€æŸ¥çŽ¯å¢ƒ
        run: |
          [ -z "$FULL_DOMAIN" ] && echo "âŒ FULL_DOMAIN æœªè®¾ç½®" && exit 1
          [ -z "$HUAWEI_ACCESS_KEY" ] && echo "âŒ HUAWEI_ACCESS_KEY æœªè®¾ç½®" && exit 1
          [ -z "$HUAWEI_SECRET_KEY" ] && echo "âŒ HUAWEI_SECRET_KEY æœªè®¾ç½®" && exit 1
          echo "âœ… çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡"

      - name: ðŸš€ è¿è¡Œè„šæœ¬
        id: update
        env:
          HIDE_DOMAIN: "true"
        run: |
          echo "ðŸš€ å¼€å§‹æ‰§è¡Œ..."
          python cloudflare_dns_updater.py

      - name: ðŸ“Š ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "# ðŸŽ¯ DNS æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ steps.update.outcome == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“Š ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            for line in é»˜è®¤ ç”µä¿¡ è”é€š ç§»åŠ¨ IPv6; do
              count=$(jq -r ".æœ€ä¼˜IP.${line} // [] | length" cloudflare_bestip.json 2>/dev/null || echo "0")
              echo "- **${line}**: ${count} ä¸ª" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: ðŸ“¦ ä¸Šä¼ ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-bestip-${{ github.run_number }}
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ðŸ’¾ æäº¤ç»“æžœ
        if: success()
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cloudflare_bestip.json cloudflare_bestip.txt 2>/dev/null || true
          
          if ! git diff --staged --quiet 2>/dev/null; then
            git commit -m "ðŸ¤– Update $(date -u '+%Y-%m-%d %H:%M') [skip ci]"
            git pull --rebase || true
            git push || echo "æŽ¨é€å¤±è´¥"
          fi

      - name: ðŸ§¹ æ¸…ç†
        if: always()
        run: rm -rf /tmp/.playwright* ~/.cache/ms-playwright 2>/dev/null || true
