name: CloudFlareä¼˜é€‰IP + åŽä¸ºäº‘æ›´æ–°DNS

on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
      FORCE_UPDATE: ${{ inputs.force_update }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”’ éšè—æ•æ„Ÿä¿¡æ¯
        run: |
          echo "::add-mask::${{ secrets.FULL_DOMAIN }}"
          echo "::add-mask::${{ secrets.HUAWEI_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.HUAWEI_SECRET_KEY }}"
          echo "::add-mask::${{ secrets.TG_BOT_TOKEN }}"
          echo "::add-mask::${{ secrets.TG_USER_ID }}"

      - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'
        continue-on-error: true

      - name: ðŸŒ é…ç½®æµè§ˆå™¨çŽ¯å¢ƒï¼ˆæ™ºèƒ½æ£€æµ‹ï¼‰
        run: |
          echo "ðŸ” æ£€æŸ¥å¯ç”¨çš„æµè§ˆå™¨..."
          
          # ä¼˜å…ˆä½¿ç”¨é¢„è£…çš„æµè§ˆå™¨
          if command -v google-chrome &> /dev/null; then
            echo "âœ… ä½¿ç”¨é¢„è£… Chrome"
            echo "PYPPETEER_EXECUTABLE_PATH=$(which google-chrome)" >> $GITHUB_ENV
            google-chrome --version
          elif command -v chromium-browser &> /dev/null; then
            echo "âœ… ä½¿ç”¨é¢„è£… Chromium"
            echo "PYPPETEER_EXECUTABLE_PATH=$(which chromium-browser)" >> $GITHUB_ENV
            chromium-browser --version
          elif command -v chromium &> /dev/null; then
            echo "âœ… ä½¿ç”¨ç³»ç»Ÿ Chromium"
            echo "PYPPETEER_EXECUTABLE_PATH=$(which chromium)" >> $GITHUB_ENV
            chromium --version
          else
            echo "âš ï¸  æœªæ‰¾åˆ°é¢„è£…æµè§ˆå™¨ï¼Œå¼€å§‹å®‰è£…..."
            sudo apt-get update -qq
            
            # å°è¯•å®‰è£…
            if sudo apt-get install -y chromium-browser 2>/dev/null; then
              echo "âœ… Chromium å®‰è£…æˆåŠŸ"
              echo "PYPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser" >> $GITHUB_ENV
            elif sudo snap install chromium 2>/dev/null; then
              echo "âœ… Chromium (Snap) å®‰è£…æˆåŠŸ"
              echo "PYPPETEER_EXECUTABLE_PATH=/snap/bin/chromium" >> $GITHUB_ENV
            else
              echo "âŒ æµè§ˆå™¨å®‰è£…å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "PYPPETEER_CHROMIUM_REVISION=latest" >> $GITHUB_ENV

      - name: ðŸ“š å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip -q
          
          if [ -f requirements.txt ]; then
            echo "ðŸ“¦ ä»Ž requirements.txt å®‰è£…..."
            pip install -r requirements.txt -q
          else
            echo "ðŸ“¦ ç›´æŽ¥å®‰è£…ä¾èµ–..."
            pip install -q \
              requests \
              beautifulsoup4 \
              requests-html \
              lxml \
              huaweicloudsdkcore \
              huaweicloudsdkdns
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          pip list | grep -E "requests|beautifulsoup4|lxml|huawei"

      - name: âœ… æ£€æŸ¥çŽ¯å¢ƒå˜é‡
        run: |
          [ -z "$FULL_DOMAIN" ] && echo "âŒ FULL_DOMAIN æœªè®¾ç½®" && exit 1
          [ -z "$HUAWEI_ACCESS_KEY" ] && echo "âŒ HUAWEI_ACCESS_KEY æœªè®¾ç½®" && exit 1
          [ -z "$HUAWEI_SECRET_KEY" ] && echo "âŒ HUAWEI_SECRET_KEY æœªè®¾ç½®" && exit 1
          echo "âœ… å¿…éœ€çŽ¯å¢ƒå˜é‡å·²é…ç½®"

      - name: ðŸš€ è¿è¡Œ DNS æ›´æ–°è„šæœ¬
        id: update_dns
        env:
          HIDE_DOMAIN: "true"
          PYPPETEER_LOG_LEVEL: ERROR  # å‡å°‘ pyppeteer æ—¥å¿—
        run: |
          echo "ðŸš€ å¼€å§‹æ‰§è¡Œ DNS æ›´æ–°..."
          echo "ðŸ“‹ é…ç½®ä¿¡æ¯ï¼š"
          echo "  - Python: $(python --version)"
          echo "  - æµè§ˆå™¨: $PYPPETEER_EXECUTABLE_PATH"
          echo "  - åŒºåŸŸ: ${HUAWEI_REGION:-ap-southeast-1}"
          echo ""
          
          # è¿è¡Œè„šæœ¬ï¼ˆä¸è¿‡æ»¤åŸŸåï¼Œç”¨äºŽè°ƒè¯•ï¼‰
          if python cloudflare_dns_updater.py; then
            echo "update_status=success" >> $GITHUB_OUTPUT
            echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            EXIT_CODE=$?
            echo "update_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
            exit $EXIT_CODE
          fi

      - name: ðŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "# ðŸŽ¯ DNS æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ steps.update_dns.outputs.update_status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œ**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“Š IP ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            
            for line in é»˜è®¤ ç”µä¿¡ è”é€š ç§»åŠ¨ IPv6; do
              count=$(jq -r ".æœ€ä¼˜IP.${line} // [] | length" cloudflare_bestip.json 2>/dev/null || echo "0")
              echo "- **${line}**: ${count} ä¸ª" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: ðŸ“¦ ä¸Šä¼ ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-bestip-${{ github.run_number }}
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ’¾ æäº¤ç»“æžœ
        if: success()
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add cloudflare_bestip.json cloudflare_bestip.txt 2>/dev/null || true
          
          if ! git diff --staged --quiet 2>/dev/null; then
            git commit -m "ðŸ¤– Update $(date -u '+%Y-%m-%d %H:%M UTC') [skip ci]"
            git pull --rebase origin ${{ github.ref_name }} || true
            git push origin ${{ github.ref_name }} || echo "æŽ¨é€å¤±è´¥æˆ–æ— å˜åŒ–"
          else
            echo "â„¹ï¸  æ— å˜åŒ–"
          fi

      - name: ðŸ§¹ æ¸…ç†
        if: always()
        run: |
          rm -rf /tmp/.com.google.Chrome.* /tmp/pyppeteer-* ~/.pyppeteer 2>/dev/null || true

      - name: ðŸ“± å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_USER_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TG_USER_ID}" \
              -d parse_mode=HTML \
              -d text="ðŸš¨ <b>DNSæ›´æ–°å¤±è´¥</b>%0A%0Aæ—¶é—´: $(date)%0Aæ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              > /dev/null 2>&1 || true
          fi
