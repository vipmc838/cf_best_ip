name: ğŸŒ Cloudflare IP ä¼˜é€‰ + åä¸ºäº‘ DNS æ›´æ–°

on:
  schedule:
    - cron: '0 */1 * * *' # â° æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # ğŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    name: ğŸ”„ æ›´æ–° DNS è®°å½•
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 huaweicloudsdkcore huaweicloudsdkdns requests-html lxml[html_clean]

      - name: ğŸš€ è¿è¡Œè„šæœ¬
        run: python cloudflare_dns_updater.py

      - name: ğŸ’¾ ä¿å­˜ JSON & TXT æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-ip-data
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ğŸ“ æäº¤ JSON & TXT æ–‡ä»¶åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cloudflare_bestip.json cloudflare_bestip.txt
          git commit -m "ğŸ”„ æ›´æ–° Cloudflare IP [skip ci]" || echo "No changes to commit"
          git pull --rebase origin HEAD || true
          git push origin HEAD || echo "Push å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰å˜åŒ–"

      - name: ğŸ“Š ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸŒ Cloudflare IP ä¼˜é€‰æ›´æ–°æŠ¥å‘Š
          
          ## ğŸ“‹ åŸºæœ¬ä¿¡æ¯
          
          | é¡¹ç›® | å†…å®¹ |
          |------|------|
          | ğŸŒ åŸŸå | `${{ secrets.FULL_DOMAIN }}` |
          | â° è¿è¡Œæ—¶é—´ | `EOF`
          echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')` (åŒ—äº¬æ—¶é—´) |" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          | ğŸ“Œ è¿è¡ŒçŠ¶æ€ | EOF`
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          | ğŸ¯ è§¦å‘æ–¹å¼ | EOF`
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "â° å®šæ—¶ä»»åŠ¡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š IP æ›´æ–°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            python3 << 'PYTHON' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  print('| çº¿è·¯ç±»å‹ | IP æ•°é‡ | çŠ¶æ€ |')
                  print('|----------|---------|------|')
                  
                  line_emoji = {
                      'é»˜è®¤': 'ğŸŒ',
                      'ç”µä¿¡': 'ğŸ“¡',
                      'è”é€š': 'ğŸ“¶',
                      'ç§»åŠ¨': 'ğŸ“±',
                      'IPv6': 'ğŸ”·'
                  }
                  
                  total_count = 0
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨', 'IPv6']:
                      ips = best.get(line, [])
                      count = len(ips)
                      total_count += count
                      emoji = line_emoji.get(line, 'ğŸ“')
                      status = 'âœ… å·²æ›´æ–°' if count > 0 else 'âšª æ— æ•°æ®'
                      print(f'| {emoji} {line} | {count} | {status} |')
                  
                  print(f'| **ğŸ¯ æ€»è®¡** | **{total_count}** | - |')
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {e}')
          PYTHON
          else
            echo "âŒ **æœªç”Ÿæˆç»“æœæ–‡ä»¶**" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶
          
          | æ–‡ä»¶å | è¯´æ˜ | ç”¨é€” |
          |--------|------|------|
          | ğŸ“„ `cloudflare_bestip.json` | JSON æ ¼å¼æ•°æ® | ç¨‹åºè°ƒç”¨ |
          | ğŸ“„ `cloudflare_bestip.txt` | çº¯æ–‡æœ¬æ ¼å¼ | å®¢æˆ·ç«¯å¯¼å…¥ |
          
          ## ğŸ”— å¿«é€Ÿé“¾æ¥
          
          - ğŸ“¥ [ä¸‹è½½ Artifacts](../../actions/runs/${{ github.run_id }})
          - ğŸ“‚ [æŸ¥çœ‹ä»“åº“æ–‡ä»¶](../../tree/${{ github.ref_name }})
          - ğŸ”„ [é‡æ–°è¿è¡Œå·¥ä½œæµ](../../actions/workflows/${{ github.workflow }})
          
          ---
          
          <div align="center">
          
          **ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ** â€¢ [æŸ¥çœ‹æ—¥å¿—](../../actions/runs/${{ github.run_id }})
          
          </div>
          EOF
          
          echo "âœ… è¿è¡ŒæŠ¥å‘Šå·²ç”Ÿæˆ"
