name: ğŸŒ Cloudflare IP ä¼˜é€‰ + åä¸ºäº‘ DNS æ›´æ–°

on:
  schedule:
    - cron: '0 */1 * * *' # â° æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # ğŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    name: ğŸ”„ æ›´æ–° DNS è®°å½•
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: ğŸ’¾ ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/cloudflare_dns_updater.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 huaweicloudsdkcore huaweicloudsdkdns requests-html lxml[html_clean]

      - name: ğŸš€ è¿è¡Œè„šæœ¬
        run: python cloudflare_dns_updater.py

      - name: ğŸ’¾ ä¿å­˜ JSON & TXT æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-ip-data
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ğŸ“ æ›´æ–° README.md æŠ¥å‘Š
        run: |
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')
          
          # ç”Ÿæˆ IP ç»Ÿè®¡
          if [ -f cloudflare_bestip.json ]; then
            IP_STATS=$(python3 << 'PYTHON'
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  lines = []
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨']:
                      ips = best.get(line, [])
                      if ips:
                          lines.append(f'- âœ… **{line} Aè®°å½•:** {len(ips)} ä¸ªIP')
                  
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      lines.append(f'- âœ… **IPv6 AAAAè®°å½•:** {len(ipv6)} ä¸ªIP')
                  
                  print('\n'.join(lines))
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {e}')
          PYTHON
          )
          else
            IP_STATS="âŒ æœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
          fi
          
          # ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
          cat > report.tmp << EOF
          ### âœ… DNS æ›´æ–°æˆåŠŸ
          
          ğŸ• **æ›´æ–°æ—¶é—´:** ${CURRENT_TIME}
          
          ${IP_STATS}
          EOF
          
          # æ›¿æ¢ README.md ä¸­çš„æŠ¥å‘Šéƒ¨åˆ†
          awk '
          BEGIN { p=1 }
          /<!-- REPORT_START -->/ { 
              print
              system("cat report.tmp")
              p=0
          }
          /<!-- REPORT_END -->/ { p=1 }
          p
          ' README.md > README.md.tmp
          
          mv README.md.tmp README.md
          rm -f report.tmp

      - name: ğŸ“ æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md cloudflare_bestip.json cloudflare_bestip.txt
          git commit -m "ğŸ”„ æ›´æ–° Cloudflare IP [skip ci]" || echo "No changes to commit"
          git pull --rebase origin HEAD || true
          git push origin HEAD || echo "Push å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰å˜åŒ–"

      - name: ğŸ“Š ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸŒ Cloudflare IP ä¼˜é€‰æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… DNS æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DNS æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• **æ—¶é—´:** $(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            python3 << 'PYTHON' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨']:
                      ips = best.get(line, [])
                      if ips:
                          print(f'âœ… **{line} Aè®°å½•:** {len(ips)} ä¸ªIP')
                  
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      print(f'âœ… **IPv6 AAAAè®°å½•:** {len(ipv6)} ä¸ªIP')
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {e}')
          PYTHON
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶
          
          | æ–‡ä»¶å | è¯´æ˜ | ç”¨é€” |
          |--------|------|------|
          | ğŸ“„ `cloudflare_bestip.json` | JSON æ ¼å¼æ•°æ® | ç¨‹åºè°ƒç”¨ |
          | ğŸ“„ `cloudflare_bestip.txt` | çº¯æ–‡æœ¬æ ¼å¼ | å®¢æˆ·ç«¯å¯¼å…¥ |
          
          ### ğŸ”— å¿«é€Ÿé“¾æ¥
          
          - ğŸ“¥ [ä¸‹è½½ Artifacts](../../actions/runs/${{ github.run_id }})
          - ğŸ“‚ [æŸ¥çœ‹ä»“åº“æ–‡ä»¶](../../tree/${{ github.ref_name }})
          EOF

  # âœ¨ æ–°å¢ï¼šæ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
  cleanup:
    name: ğŸ§¹ æ¸…ç†æ—§è¿è¡Œè®°å½•
    runs-on: ubuntu-latest
    needs: update_dns  # ç­‰å¾…ä¸»ä»»åŠ¡å®Œæˆ
    if: always()  # æ— è®ºä¸»ä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œ
    
    steps:
      - name: ğŸ—‘ï¸ åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œ
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          ä»“åº“: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 4
