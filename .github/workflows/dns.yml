name: ðŸŒ Cloudflare IP ä¼˜é€‰ + åŽä¸ºäº‘ DNS æ›´æ–°

on:
  schedule:
    - cron: '0 */1 * * *' # â° æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # ðŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    name: ðŸ”„ æ›´æ–° DNS è®°å½•
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: ðŸ’¾ ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/cloudflare_dns_updater.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ðŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 huaweicloudsdkcore huaweicloudsdkdns requests-html lxml[html_clean]

      - name: ðŸš€ è¿è¡Œè„šæœ¬
        run: python cloudflare_dns_updater.py

      - name: ðŸ’¾ ä¿å­˜ JSON & TXT æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-ip-data
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ðŸ“ æäº¤ JSON & TXT æ–‡ä»¶åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cloudflare_bestip.json cloudflare_bestip.txt
          git commit -m "ðŸ”„ æ›´æ–° Cloudflare IP [skip ci]" || echo "No changes to commit"
          git pull --rebase origin HEAD || true
          git push origin HEAD || echo "Push å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰å˜åŒ–"

      - name: ðŸ“Š ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸŒ Cloudflare IP ä¼˜é€‰æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… DNS æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DNS æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **æ—¶é—´:** $(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            python3 << 'PYTHON' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  # IPv4 çº¿è·¯
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨']:
                      ips = best.get(line, [])
                      if ips:
                          print(f'âœ… **{line} Aè®°å½•:** {len(ips)} ä¸ªIP')
                  
                  # IPv6
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      print(f'âœ… **IPv6 AAAAè®°å½•:** {len(ipv6)} ä¸ªIP')
          except Exception as e:
              print(f'âŒ è§£æžå¤±è´¥: {e}')
          PYTHON
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶
          
          | æ–‡ä»¶å | è¯´æ˜Ž | ç”¨é€” |
          |--------|------|------|
          | ðŸ“„ `cloudflare_bestip.json` | JSON æ ¼å¼æ•°æ® | ç¨‹åºè°ƒç”¨ |
          | ðŸ“„ `cloudflare_bestip.txt` | çº¯æ–‡æœ¬æ ¼å¼ | å®¢æˆ·ç«¯å¯¼å…¥ |
          
          ### ðŸ”— å¿«é€Ÿé“¾æŽ¥
          
          - ðŸ“¥ [ä¸‹è½½ Artifacts](../../actions/runs/${{ github.run_id }})
          - ðŸ“‚ [æŸ¥çœ‹ä»“åº“æ–‡ä»¶](../../tree/${{ github.ref_name }})
          EOF
