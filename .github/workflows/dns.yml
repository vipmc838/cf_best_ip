name: ğŸŒ Cloudflare IP ä¼˜é€‰ + åä¸ºäº‘ DNS æ›´æ–°

on:
  schedule:
    - cron: '0 */1 * * *' # â° æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # ğŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      notify:
        description: 'æ˜¯å¦å‘é€ Telegram é€šçŸ¥'
        required: false
        default: 'true'

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    name: ğŸ”„ æ›´æ–° DNS è®°å½•
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–åŒ…
        run: |
          echo "ğŸ“Œ æ­£åœ¨å®‰è£… Python ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 \
                      huaweicloudsdkcore huaweicloudsdkdns \
                      requests-html lxml[html_clean]
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸš€ æ‰§è¡Œ DNS æ›´æ–°è„šæœ¬
        id: run_script
        run: |
          echo "ğŸ” å¼€å§‹è·å– Cloudflare ä¼˜é€‰ IP..."
          python cloudflare_dns_updater.py
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ğŸ“Š æ˜¾ç¤ºæ›´æ–°ç»“æœ
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DNS æ›´æ–°å®Œæˆï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f cloudflare_bestip.json ]; then
            echo "ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶:"
            ls -lh cloudflare_bestip.* | awk '{print "  - " $9 " (" $5 ")"}'
          fi

      - name: ğŸ’¾ ä¸Šä¼ ç»“æœæ–‡ä»¶
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: cloudflare-ip-data-${{ github.run_number }}
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ğŸ“ æäº¤æ›´æ–°åˆ°ä»“åº“
        if: success()
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ–°..."
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f cloudflare_bestip.json ] && [ -f cloudflare_bestip.txt ]; then
            git add cloudflare_bestip.json cloudflare_bestip.txt
            
            if git diff --staged --quiet; then
              echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            else
              TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              git commit -m "ğŸ”„ æ›´æ–° Cloudflare ä¼˜é€‰ IP | $TIMESTAMP [skip ci]"
              
              echo "ğŸ”„ æ‹‰å–è¿œç¨‹æ›´æ–°..."
              git pull --rebase origin ${{ github.ref_name }} || true
              
              echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
              git push origin ${{ github.ref_name }} && echo "âœ… æ¨é€æˆåŠŸ" || echo "âš ï¸ æ¨é€å¤±è´¥"
            fi
          else
            echo "âš ï¸ ç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤"
          fi

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Artifacts
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const days = 7;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            let deleted = 0;
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('cloudflare-ip-data-') && 
                  new Date(artifact.created_at).getTime() < timestamp) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                deleted++;
              }
            }
            console.log(`ğŸ—‘ï¸ å·²æ¸…ç† ${deleted} ä¸ªè¿‡æœŸçš„ Artifacts`);

      - name: âŒ å¤„ç†å¤±è´¥æƒ…å†µ
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DNS æ›´æ–°å¤±è´¥ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          exit 1

      - name: ğŸ“Š ç”Ÿæˆè¿è¡Œæ‘˜è¦
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸŒ Cloudflare IP ä¼˜é€‰æ›´æ–°æŠ¥å‘Š
          
          ### ğŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **åŸŸå**: `${{ secrets.FULL_DOMAIN }}`
          - **è¿è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (UTC+8)
          - **è¿è¡ŒçŠ¶æ€**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'schedule' && 'â° å®šæ—¶ä»»åŠ¡' || 'ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘' }}
          
          ### ğŸ“Š æ›´æ–°ç»Ÿè®¡
          EOF
          
          if [ -f cloudflare_bestip.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            python3 << 'PYTHON'
          import json
          with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
              best = data.get('æœ€ä¼˜IP', {})
              for line, ips in best.items():
                  if ips:
                      print(f"{line}: {len(ips)} ä¸ª IP")
          PYTHON
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo 'âš ï¸ æœªç”Ÿæˆç»“æœæ–‡ä»¶' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶' >> $GITHUB_STEP_SUMMARY
          echo '- `cloudflare_bestip.json` - å®Œæ•´ JSON æ•°æ®' >> $GITHUB_STEP_SUMMARY
          echo '- `cloudflare_bestip.txt` - çº¯æ–‡æœ¬æ ¼å¼ï¼ˆå¯ç”¨äºå®¢æˆ·ç«¯ï¼‰' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '---' >> $GITHUB_STEP_SUMMARY
          echo '*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*' >> $GITHUB_STEP_SUMMARY
