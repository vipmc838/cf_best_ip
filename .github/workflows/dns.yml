name: 🌐 Cloudflare IP 优选 + 华为云 DNS 更新

on:
  schedule:
    - cron: '0 */1 * * *' # ⏰ 每小时自动运行
  workflow_dispatch: # 🖱️ 支持手动触发

permissions:
  contents: write
  actions: read

jobs:
  update_dns:
    name: 🔄 更新 DNS 记录
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4

      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: 💾 缓存 pip 依赖
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/cloudflare_dns_updater.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 📦 安装 Python 依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 huaweicloudsdkcore huaweicloudsdkdns requests-html lxml[html_clean]

      - name: 🚀 运行脚本
        run: python cloudflare_dns_updater.py

      - name: 💾 保存 JSON & TXT 文件
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-ip-data
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: 📝 提交 JSON & TXT 文件到仓库
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cloudflare_bestip.json cloudflare_bestip.txt
          git commit -m "🔄 更新 Cloudflare IP [skip ci]" || echo "No changes to commit"
          git pull --rebase origin HEAD || true
          git push origin HEAD || echo "Push 失败，可能没有变化"

      - name: 📊 生成运行报告
        if: always()
        run: |
          echo "## 🌐 Cloudflare IP 优选更新报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ✅ DNS 更新成功" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ DNS 更新失败" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 基本信息" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🕐 **时间:** $(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            python3 << 'PYTHON' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('最优IP', {})
                  
                  # IPv4 线路
                  for line in ['默认', '电信', '联通', '移动']:
                      ips = best.get(line, [])
                      if ips:
                          print(f'✅ **{line} A记录:** {len(ips)} 个IP')
                  
                  # IPv6
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      print(f'✅ **IPv6 AAAA记录:** {len(ipv6)} 个IP')
          except Exception as e:
              print(f'❌ 解析失败: {e}')
          PYTHON
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### 📦 生成的文件
          
          | 文件名 | 说明 | 用途 |
          |--------|------|------|
          | 📄 `cloudflare_bestip.json` | JSON 格式数据 | 程序调用 |
          | 📄 `cloudflare_bestip.txt` | 纯文本格式 | 客户端导入 |
          
          ### 🔗 快速链接
          
          - 📥 [下载 Artifacts](../../actions/runs/${{ github.run_id }})
          - 📂 [查看仓库文件](../../tree/${{ github.ref_name }})
          EOF
