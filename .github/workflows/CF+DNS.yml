name: ğŸŒ Cloudflare IP ä¼˜é€‰ + åä¸ºäº‘ DNS
on:
  schedule:
    - cron: '0 */1 * * *' # â° æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # ğŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: write  # å…è®¸åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•

jobs:
  update_dns:
    name: ğŸ”„ æ›´æ–° DNS è®°å½•
    runs-on: ubuntu-latest
    
    env:
      FULL_DOMAIN: ${{ secrets.FULL_DOMAIN }}
      HUAWEI_ACCESS_KEY: ${{ secrets.HUAWEI_ACCESS_KEY }}
      HUAWEI_SECRET_KEY: ${{ secrets.HUAWEI_SECRET_KEY }}
      HUAWEI_REGION: ${{ secrets.HUAWEI_REGION }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: ğŸ’¾ ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/cloudflare_dns_updater.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 huaweicloudsdkcore huaweicloudsdkdns requests-html lxml[html_clean]

      - name: ğŸš€ è¿è¡Œè„šæœ¬
        run: python cloudflare_dns_updater.py

      - name: ğŸ’¾ ä¿å­˜ JSON & TXT æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-ip-data
          path: |
            cloudflare_bestip.json
            cloudflare_bestip.txt
          retention-days: 7

      - name: ğŸ“ æ›´æ–° README.md æŠ¥å‘Š
        run: |
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')
          
          # ç”Ÿæˆ IP ç»Ÿè®¡
          if [ -f cloudflare_bestip.json ]; then
            IP_STATS=$(python3 << 'PYTHON'
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  lines = []
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨']:
                      ips = best.get(line, [])
                      if ips:
                          lines.append(f'- âœ… **{line} Aè®°å½•:** {len(ips)} ä¸ªIP')
                  
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      lines.append(f'- âœ… **IPv6 AAAAè®°å½•:** {len(ipv6)} ä¸ªIP')
                  
                  print('\n'.join(lines))
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {e}')
          PYTHON
          )
          else
            IP_STATS="âŒ æœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
          fi
          
          # ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
          cat > report.tmp << EOF
          ### âœ… DNS æ›´æ–°æˆåŠŸ
          
          ğŸ• **æ›´æ–°æ—¶é—´:** ${CURRENT_TIME}
          
          ${IP_STATS}
          EOF
          
          # æ›¿æ¢ README.md ä¸­çš„æŠ¥å‘Šéƒ¨åˆ†
          awk '
          BEGIN { p=1 }
          /<!-- REPORT_START -->/ { 
              print
              system("cat report.tmp")
              p=0
          }
          /<!-- REPORT_END -->/ { p=1 }
          p
          ' README.md > README.md.tmp
          
          mv README.md.tmp README.md
          rm -f report.tmp

      - name: ğŸ“ æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md cloudflare_bestip.json cloudflare_bestip.txt
          git commit -m "ğŸ”„ æ›´æ–° Cloudflare IP [skip ci]" || echo "No changes to commit"
          git pull --rebase origin HEAD || true
          git push origin HEAD || echo "Push å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰å˜åŒ–"

      - name: ğŸ“Š ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸŒ Cloudflare IP ä¼˜é€‰æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… DNS æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DNS æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• **æ—¶é—´:** $(TZ='Asia/Shanghai' date '+%Y/%m/%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cloudflare_bestip.json ]; then
            python3 << 'PYTHON' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('cloudflare_bestip.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  best = data.get('æœ€ä¼˜IP', {})
                  
                  for line in ['é»˜è®¤', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨']:
                      ips = best.get(line, [])
                      if ips:
                          print(f'âœ… **{line} Aè®°å½•:** {len(ips)} ä¸ªIP')
                  
                  ipv6 = best.get('IPv6', [])
                  if ipv6:
                      print(f'âœ… **IPv6 AAAAè®°å½•:** {len(ipv6)} ä¸ªIP')
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {e}')
          PYTHON
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶
          
          | æ–‡ä»¶å | è¯´æ˜ | ç”¨é€” |
          |--------|------|------|
          | ğŸ“„ `cloudflare_bestip.json` | JSON æ ¼å¼æ•°æ® | ç¨‹åºè°ƒç”¨ |
          | ğŸ“„ `cloudflare_bestip.txt` | çº¯æ–‡æœ¬æ ¼å¼ | å®¢æˆ·ç«¯å¯¼å…¥ |
          
          ### ğŸ”— å¿«é€Ÿé“¾æ¥
          
          - ğŸ“¥ [ä¸‹è½½ Artifacts](../../actions/runs/${{ github.run_id }})
          - ğŸ“‚ [æŸ¥çœ‹ä»“åº“æ–‡ä»¶](../../tree/${{ github.ref_name }})
          EOF

      # âœ¨ ä½¿ç”¨ GitHub CLI æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œ
        if: success()  # åªåœ¨æˆåŠŸæ—¶æ¸…ç†
        continue-on-error: true  # å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” å¼€å§‹æ¸…ç†æ—§è¿è¡Œè®°å½•..."
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ·ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
          echo ""
          
          # è·å–å½“å‰å·¥ä½œæµçš„ ID
          WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows \
            --jq '.workflows[] | select(.name=="${{ github.workflow }}") | .id')
          
          if [ -z "$WORKFLOW_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥ä½œæµ ID"
            exit 0
          fi
          
          echo "ğŸ“‹ å·¥ä½œæµ ID: $WORKFLOW_ID"
          echo ""
          
          # è·å–æ‰€æœ‰è¿è¡Œè®°å½•çš„æ€»æ•°
          TOTAL_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/${WORKFLOW_ID}/runs?per_page=1" \
            --jq '.total_count')
          
          echo "ğŸ“Š æ€»è¿è¡Œæ¬¡æ•°: $TOTAL_RUNS"
          
          if [ "$TOTAL_RUNS" -le 4 ]; then
            echo "âœ… è¿è¡Œè®°å½•ä¸è¶…è¿‡ 4 æ¡ï¼Œæ— éœ€æ¸…ç†"
            exit 0
          fi
          
          # è·å–éœ€è¦åˆ é™¤çš„è¿è¡Œ IDï¼ˆè·³è¿‡æœ€æ–°çš„ 4 æ¡ï¼‰
          echo "ğŸ” è·å–éœ€è¦åˆ é™¤çš„è¿è¡Œè®°å½•..."
          
          RUN_IDS=$(gh api "repos/${{ github.repository }}/actions/workflows/${WORKFLOW_ID}/runs?per_page=100" \
            --jq '.workflow_runs[4:] | .[].id')
          
          if [ -z "$RUN_IDS" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„è®°å½•"
            exit 0
          fi
          
          # ç»Ÿè®¡éœ€è¦åˆ é™¤çš„æ•°é‡
          DELETE_COUNT=$(echo "$RUN_IDS" | wc -l)
          echo "ğŸ—‘ï¸  å‡†å¤‡åˆ é™¤ $DELETE_COUNT æ¡æ—§è®°å½•"
          echo ""
          
          # åˆ é™¤æ—§è¿è¡Œè®°å½•
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for run_id in $RUN_IDS; do
            echo -n "ğŸ—‘ï¸  åˆ é™¤è¿è¡Œ #$run_id ... "
            
            if gh api -X DELETE "repos/${{ github.repository }}/actions/runs/${run_id}" 2>/dev/null; then
              echo "âœ…"
              ((SUCCESS_COUNT++))
            else
              echo "âŒ"
              ((FAIL_COUNT++))
            fi
            
            # é¿å…è¯·æ±‚è¿‡å¿«
            sleep 0.5
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… æ¸…ç†å®Œæˆï¼"
          echo "ğŸ“Š æˆåŠŸåˆ é™¤: $SUCCESS_COUNT æ¡"
          [ $FAIL_COUNT -gt 0 ] && echo "âš ï¸  åˆ é™¤å¤±è´¥: $FAIL_COUNT æ¡"
          echo "ğŸ“¦ ä¿ç•™æœ€æ–°: 4 æ¡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
